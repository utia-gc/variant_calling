nextflow_workflow {

    name "Test Workflow CHECK_QUALITY"
    script "workflows/check_quality.nf"
    workflow "CHECK_QUALITY"

    test("CHECK_QUALITY succeeds with default params -- cutadapt + SE reads.") {
        // instantiate helper objects
        def readsRaw      = new ReadsSELane1()
        def readsPrealign = new ReadsSELane2()
        def refs          = new RefsEnsembl()

        when {
            params {
                publishDirReports = "${outputDir}/reports"
                publishDirData    = "${outputDir}/data"
            }
            workflow {
                """
                input[0] = [
                    [
                        sampleName:   "${readsRaw.getSampleName()}",
                        sampleNumber: "${readsRaw.getSampleNumber()}",
                        lane:         "${readsRaw.getLane()}",
                        readType:     "${readsRaw.getReadType()}"
                    ],
                    [
                        file("${readsRaw.getR1()}")
                    ]
                ]
                input[1] = [
                    [
                        sampleName:   "${readsPrealign.getSampleName()}",
                        sampleNumber: "${readsPrealign.getSampleNumber()}",
                        lane:         "${readsPrealign.getLane()}",
                        readType:     "${readsPrealign.getReadType()}"
                    ],
                    [
                        file("${readsPrealign.getR1()}")
                    ]
                ]
                input[2] = Channel.of(file("https://github.com/ewels/MultiQC_TestData/raw/master/data/modules/cutadapt/v2.10/SAMPLE3_SE.cutadapt.log"))
                input[4] = file("${refs.getGenomeIndex()}")
                """
            }
        }

        then {
            // test workflow status
            assert workflow.success
            assert workflow.trace.succeeded().size() == 6

            // test FastQC html files get published to reports directory
            def htmlRaw      = path("${params.publishDirReports}/fastqc/${readsRaw.getR1SimpleName()}_fastqc.html")
            def htmlPrealign = path("${params.publishDirReports}/fastqc/${readsPrealign.getR1SimpleName()}_fastqc.html")
            assert htmlRaw.exists()
            assert htmlPrealign.exists()
            // test FastQC zip files get published to reports directory
            def zipRaw       = path("${params.publishDirReports}/fastqc/${readsRaw.getR1SimpleName()}_fastqc.zip")
            def zipPrealign  = path("${params.publishDirReports}/fastqc/${readsPrealign.getR1SimpleName()}_fastqc.zip")
            assert zipRaw.exists()
            assert zipPrealign.exists()
            // test MultiQC html reports get published to reports directory
            def htmlMQCRaw         = path("${params.publishDirReports}/multiqc/reads_raw/reads_raw.html")
            def htmlMQCPrealign    = path("${params.publishDirReports}/multiqc/reads_prealign/reads_prealign.html")
            def htmlMQCFull        = path("${params.publishDirReports}/multiqc/ngs/ngs.html")
            assert htmlMQCRaw.exists()
            assert htmlMQCPrealign.exists()
            assert htmlMQCFull.exists()
            // test MultiQC data files get published to reports directory
            def dataDirMQCRaw      = path("${params.publishDirReports}/multiqc/reads_raw/reads_raw_data")
            def dataDirMQCPrealign = path("${params.publishDirReports}/multiqc/reads_prealign/reads_prealign_data")
            def dataDirMQCFull     = path("${params.publishDirReports}/multiqc/ngs/ngs_data")
            assert dataDirMQCRaw.exists()
            assert dataDirMQCPrealign.exists()
            assert dataDirMQCFull.exists()
        }

    }

    test("CHECK_QUALITY succeeds with default params -- cutadapt + PE reads.") {
        // instantiate helper objects
        def readsRaw      = new ReadsPELane1()
        def readsPrealign = new ReadsPELane2()
        def refs          = new RefsEnsembl()

        when {
            params {
                publishDirReports = "${outputDir}/reports"
                publishDirData    = "${outputDir}/data"
            }
            workflow {
                """
                input[0] = [
                    [
                        sampleName:   "${readsRaw.getSampleName()}",
                        sampleNumber: "${readsRaw.getSampleNumber()}",
                        lane:         "${readsRaw.getLane()}",
                        readType:     "${readsRaw.getReadType()}"
                    ],
                    [
                        file("${readsRaw.getR1()}"),
                        file("${readsRaw.getR2()}")
                    ]
                ]
                input[1] = [
                    [
                        sampleName:   "${readsPrealign.getSampleName()}",
                        sampleNumber: "${readsPrealign.getSampleNumber()}",
                        lane:         "${readsPrealign.getLane()}",
                        readType:     "${readsPrealign.getReadType()}"
                    ],
                    [
                        file("${readsPrealign.getR1()}"),
                        file("${readsPrealign.getR2()}")
                    ]
                ]
                input[2] = Channel.of(file("https://github.com/ewels/MultiQC_TestData/raw/master/data/modules/cutadapt/v2.10/SAMPLE3_SE.cutadapt.log"))
                input[4] = file("${refs.getGenomeIndex()}")
                """
            }
        }

        then {
            // test workflow status
            assert workflow.success
            assert workflow.trace.succeeded().size() == 6

            // test FastQC html files get published to reports directory
            def htmlR1Raw      = path("${params.publishDirReports}/fastqc/${readsRaw.getR1SimpleName()}_fastqc.html")
            def htmlR2Raw      = path("${params.publishDirReports}/fastqc/${readsRaw.getR2SimpleName()}_fastqc.html")
            assert htmlR1Raw.exists()
            assert htmlR2Raw.exists()
            def htmlR1Prealign = path("${params.publishDirReports}/fastqc/${readsPrealign.getR1SimpleName()}_fastqc.html")
            def htmlR2Prealign = path("${params.publishDirReports}/fastqc/${readsPrealign.getR2SimpleName()}_fastqc.html")
            assert htmlR1Prealign.exists()
            assert htmlR2Prealign.exists()
            // test FastQC zip files get published to reports directory
            def zipR1Raw       = path("${params.publishDirReports}/fastqc/${readsRaw.getR1SimpleName()}_fastqc.zip")
            def zipR2Raw       = path("${params.publishDirReports}/fastqc/${readsRaw.getR2SimpleName()}_fastqc.zip")
            assert zipR1Raw.exists()
            assert zipR2Raw.exists()
            def zipR1Prealign  = path("${params.publishDirReports}/fastqc/${readsPrealign.getR1SimpleName()}_fastqc.zip")
            def zipR2Prealign  = path("${params.publishDirReports}/fastqc/${readsPrealign.getR2SimpleName()}_fastqc.zip")
            assert zipR1Prealign.exists()
            assert zipR2Prealign.exists()
            // test MultiQC html reports get published to reports directory
            def htmlMQCRaw         = path("${params.publishDirReports}/multiqc/reads_raw/reads_raw.html")
            def htmlMQCPrealign    = path("${params.publishDirReports}/multiqc/reads_prealign/reads_prealign.html")
            def htmlMQCFull        = path("${params.publishDirReports}/multiqc/ngs/ngs.html")
            assert htmlMQCRaw.exists()
            assert htmlMQCPrealign.exists()
            assert htmlMQCFull.exists()
            // test MultiQC data files get published to reports directory
            def dataDirMQCRaw      = path("${params.publishDirReports}/multiqc/reads_raw/reads_raw_data")
            def dataDirMQCPrealign = path("${params.publishDirReports}/multiqc/reads_prealign/reads_prealign_data")
            def dataDirMQCFull     = path("${params.publishDirReports}/multiqc/ngs/ngs_data")
            assert dataDirMQCRaw.exists()
            assert dataDirMQCPrealign.exists()
            assert dataDirMQCFull.exists()
        }

    }

    test("CHECK_QUALITY succeeds and skips raw reads with `params.skipRawReadsQC` -- cutadapt + PE reads.") {
        // instantiate helper objects
        def readsRaw      = new ReadsPELane1()
        def readsPrealign = new ReadsPELane2()
        def refs          = new RefsEnsembl()

        when {
            params {
                publishDirReports = "${outputDir}/reports"
                publishDirData    = "${outputDir}/data"
                skipRawReadsQC    = true
            }
            workflow {
                """
                input[0] = [
                    [
                        sampleName:   "${readsRaw.getSampleName()}",
                        sampleNumber: "${readsRaw.getSampleNumber()}",
                        lane:         "${readsRaw.getLane()}",
                        readType:     "${readsRaw.getReadType()}"
                    ],
                    [
                        file("${readsRaw.getR1()}"),
                        file("${readsRaw.getR2()}")
                    ]
                ]
                input[1] = [
                    [
                        sampleName:   "${readsPrealign.getSampleName()}",
                        sampleNumber: "${readsPrealign.getSampleNumber()}",
                        lane:         "${readsPrealign.getLane()}",
                        readType:     "${readsPrealign.getReadType()}"
                    ],
                    [
                        file("${readsPrealign.getR1()}"),
                        file("${readsPrealign.getR2()}")
                    ]
                ]
                input[2] = Channel.of(file("https://github.com/ewels/MultiQC_TestData/raw/master/data/modules/cutadapt/v2.10/SAMPLE3_SE.cutadapt.log"))
                input[4] = file("${refs.getGenomeIndex()}")
                """
            }
        }

        then {
            // test workflow status
            assert workflow.success
            assert workflow.trace.succeeded().size() == 3

            // test FastQC html files get published to reports directory
            def htmlR1Prealign = path("${params.publishDirReports}/fastqc/${readsPrealign.getR1SimpleName()}_fastqc.html")
            def htmlR2Prealign = path("${params.publishDirReports}/fastqc/${readsPrealign.getR2SimpleName()}_fastqc.html")
            assert htmlR1Prealign.exists()
            assert htmlR2Prealign.exists()
            // test FastQC zip files get published to reports directory
            def zipR1Prealign  = path("${params.publishDirReports}/fastqc/${readsPrealign.getR1SimpleName()}_fastqc.zip")
            def zipR2Prealign  = path("${params.publishDirReports}/fastqc/${readsPrealign.getR2SimpleName()}_fastqc.zip")
            assert zipR1Prealign.exists()
            assert zipR2Prealign.exists()
            // test MultiQC html reports get published to reports directory
            def htmlMQCPrealign    = path("${params.publishDirReports}/multiqc/reads_prealign/reads_prealign.html")
            def htmlMQCFull        = path("${params.publishDirReports}/multiqc/ngs/ngs.html")
            assert htmlMQCPrealign.exists()
            assert htmlMQCFull.exists()
            // test MultiQC data files get published to reports directory
            def dataDirMQCPrealign = path("${params.publishDirReports}/multiqc/reads_prealign/reads_prealign_data")
            def dataDirMQCFull     = path("${params.publishDirReports}/multiqc/ngs/ngs_data")
            assert dataDirMQCPrealign.exists()
            assert dataDirMQCFull.exists()
        }

    }

    test("CHECK_QUALITY succeeds and skips raw reads QC with `params.skipPrealignReadsQC` -- cutadapt + PE reads.") {
        // instantiate helper objects
        def readsRaw      = new ReadsPELane1()
        def readsPrealign = new ReadsPELane2()
        def refs          = new RefsEnsembl()

        when {
            params {
                publishDirReports   = "${outputDir}/reports"
                publishDirData      = "${outputDir}/data"
                skipPrealignReadsQC = true
            }
            workflow {
                """
                input[0] = [
                    [
                        sampleName:   "${readsRaw.getSampleName()}",
                        sampleNumber: "${readsRaw.getSampleNumber()}",
                        lane:         "${readsRaw.getLane()}",
                        readType:     "${readsRaw.getReadType()}"
                    ],
                    [
                        file("${readsRaw.getR1()}"),
                        file("${readsRaw.getR2()}")
                    ]
                ]
                input[1] = [
                    [
                        sampleName:   "${readsPrealign.getSampleName()}",
                        sampleNumber: "${readsPrealign.getSampleNumber()}",
                        lane:         "${readsPrealign.getLane()}",
                        readType:     "${readsPrealign.getReadType()}"
                    ],
                    [
                        file("${readsPrealign.getR1()}"),
                        file("${readsPrealign.getR2()}")
                    ]
                ]
                input[2] = Channel.of(file("https://github.com/ewels/MultiQC_TestData/raw/master/data/modules/cutadapt/v2.10/SAMPLE3_SE.cutadapt.log"))
                input[4] = file("${refs.getGenomeIndex()}")
                """
            }
        }

        then {
            // test workflow status
            assert workflow.success
            assert workflow.trace.succeeded().size() == 4

            // test FastQC html files get published to reports directory
            def htmlR1Raw      = path("${params.publishDirReports}/fastqc/${readsRaw.getR1SimpleName()}_fastqc.html")
            def htmlR2Raw      = path("${params.publishDirReports}/fastqc/${readsRaw.getR2SimpleName()}_fastqc.html")
            assert htmlR1Raw.exists()
            assert htmlR2Raw.exists()
            // test FastQC zip files get published to reports directory
            def zipR1Raw       = path("${params.publishDirReports}/fastqc/${readsRaw.getR1SimpleName()}_fastqc.zip")
            def zipR2Raw       = path("${params.publishDirReports}/fastqc/${readsRaw.getR2SimpleName()}_fastqc.zip")
            assert zipR1Raw.exists()
            assert zipR2Raw.exists()
            // test MultiQC html reports get published to reports directory
            def htmlMQCRaw         = path("${params.publishDirReports}/multiqc/reads_raw/reads_raw.html")
            def htmlMQCFull        = path("${params.publishDirReports}/multiqc/ngs/ngs.html")
            assert htmlMQCRaw.exists()
            assert htmlMQCFull.exists()
            // test MultiQC data files get published to reports directory
            def dataDirMQCRaw      = path("${params.publishDirReports}/multiqc/reads_raw/reads_raw_data")
            def dataDirMQCFull     = path("${params.publishDirReports}/multiqc/ngs/ngs_data")
            assert dataDirMQCRaw.exists()
            assert dataDirMQCFull.exists()
        }

    }

    test("CHECK_QUALITY succeeds and skips raw and prealign reads QC with `params.skipRawReadsQC` and `params.skipPrealignReadsQC` -- cutadapt + PE reads.") {
        // instantiate helper objects
        def readsRaw      = new ReadsPELane1()
        def readsPrealign = new ReadsPELane2()
        def refs          = new RefsEnsembl()

        when {
            params {
                publishDirReports   = "${outputDir}/reports"
                publishDirData      = "${outputDir}/data"
                skipRawReadsQC      = true
                skipPrealignReadsQC = true
            }
            workflow {
                """
                input[0] = [
                    [
                        sampleName:   "${readsRaw.getSampleName()}",
                        sampleNumber: "${readsRaw.getSampleNumber()}",
                        lane:         "${readsRaw.getLane()}",
                        readType:     "${readsRaw.getReadType()}"
                    ],
                    [
                        file("${readsRaw.getR1()}"),
                        file("${readsRaw.getR2()}")
                    ]
                ]
                input[1] = [
                    [
                        sampleName:   "${readsPrealign.getSampleName()}",
                        sampleNumber: "${readsPrealign.getSampleNumber()}",
                        lane:         "${readsPrealign.getLane()}",
                        readType:     "${readsPrealign.getReadType()}"
                    ],
                    [
                        file("${readsPrealign.getR1()}"),
                        file("${readsPrealign.getR2()}")
                    ]
                ]
                input[2] = Channel.of(file("https://github.com/ewels/MultiQC_TestData/raw/master/data/modules/cutadapt/v2.10/SAMPLE3_SE.cutadapt.log"))
                input[4] = file("${refs.getGenomeIndex()}")
                """
            }
        }

        then {
            // test workflow status
            assert workflow.success
            assert workflow.trace.succeeded().size() == 0
        }

    }

}
